<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coroutines for R • coro</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Coroutines for R">
<meta property="og:description" content="Provides coroutines for R, a family of functions that
    can be suspended and resumed later on. This includes async
    functions (which await) and generators (which yield). Async
    functions are based on the concurrency framework of the promises
    package. Generators are based on a dependency free iteration
    protocol defined in coro and are compatible with iterators from
    the reticulate package.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">coro</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/generator.html">Generators</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/coro/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="coro" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#coro" class="anchor"></a>coro</h1></div>
<!-- badges: start -->

<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>coro implements <strong>coroutines</strong> for R, i.e. functions that can be suspended and resumed later on. There are two kinds:</p>
<ul>
<li>
<strong>Async</strong> functions, which make it straightforward to program concurrently</li>
<li>
<strong>Generators</strong> for iterating over complex sequences</li>
</ul>
<p>Supported features:</p>
<ul>
<li>Suspending within loops and if/else branches</li>
<li>Suspending within <code><a href="https://rdrr.io/r/base/conditions.html">tryCatch()</a></code>
</li>
<li>
<code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> expressions and stack-based cleanup such as provided by <code>local_</code> functions in the <a href="https://github.com/r-lib/withr/">withr</a> package</li>
<li>Step-debugging and <code><a href="https://rdrr.io/r/base/browser.html">browser()</a></code> within coroutines</li>
</ul>
<p>Compatibility with:</p>
<ul>
<li>Python iterators from the <a href="https://rstudio.github.io/reticulate/">reticulate</a> package</li>
<li>Async operations from the <a href="https://github.com/rstudio/promises/">promises</a> package</li>
<li>Parallel computations from the <a href="https://github.com/HenrikBengtsson/future">future</a> package</li>
</ul>
<p>Attach the package to follow the examples:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/coro">coro</a></span><span class="op">)</span></code></pre></div>
<div id="asyncawait-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#asyncawait-functions" class="anchor"></a>Async/await functions</h3>
<p>Concurrent programming is made straightforward by async-await functions. Whenever you are waiting for a result that may take a while (downloading a file, computing a value in an external process), use <code><a href="reference/async.html">await()</a></code>. The argument to <code><a href="reference/async.html">await()</a></code> must return a promise from the <a href="https://github.com/rstudio/promises/">promises</a> package.</p>
<p>Concurrent code based on promises can quickly become hard to write and follow. In the following artificial example, we wait for a download to complete, then decide to launch a computation in an external process depending on a property of the downloaded data. We also handle some errors specifically.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_async</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">async_download</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">then</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu">then</span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="fu">future</span><span class="op">(</span><span class="fu">fib</span><span class="op">(</span><span class="fl">30</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fib</span><span class="op">)</span> <span class="op">{</span>
          <span class="va">data</span> <span class="op">/</span> <span class="va">fib</span>
        <span class="op">}</span><span class="op">)</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="va">data</span>
      <span class="op">}</span>
    <span class="op">}</span>, onRejected <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">err</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">err</span>, <span class="st">"download_error"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="cn">NULL</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span>
      <span class="op">}</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Rewriting this function with async/await greatly simplifies the code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_async</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/async.html">async</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span>
    <span class="fu"><a href="reference/async.html">await</a></span><span class="op">(</span><span class="fu">async_download</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
    download_error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">err</span><span class="op">)</span> <span class="cn">NULL</span>
  <span class="op">)</span>

  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">fib</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/async.html">await</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="fu">future</span><span class="op">(</span><span class="fu">fib</span><span class="op">(</span><span class="fl">30</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">/</span><span class="va">fib</span>
  <span class="op">}</span>

  <span class="va">data</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
<div id="generators" class="section level3">
<h3 class="hasAnchor">
<a href="#generators" class="anchor"></a>Generators</h3>
<p>Generators are based on a simple iteration protocol:</p>
<ul>
<li>Iterators are functions.</li>
<li>They can be advanced by calling the function. The new value is returned.</li>
<li>An exhausted iterator returns the sentinel symbol <code>exhausted</code>.</li>
</ul>
<p>The <code><a href="reference/generator.html">generator()</a></code> function creates a generator factory which returns generator instances:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create a generator factory</span>
<span class="va">generate_abc</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/generator.html">generator</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="reference/yield.html">yield</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Create a generator instance</span>
<span class="va">abc</span> <span class="op">&lt;-</span> <span class="fu">generate_abc</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>A generator instance is an iterator function which yields values:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">abc</span>
<span class="co">#&gt; &lt;generator/instance&gt;</span>
<span class="co">#&gt; function() {</span>
<span class="co">#&gt;   for (x in letters[1:3]) {</span>
<span class="co">#&gt;     yield(x)</span>
<span class="co">#&gt;   }</span>
<span class="co">#&gt; }</span>

<span class="fu">abc</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "a"</span></code></pre></div>
<p>Collect all remaining values from an iterator with <code><a href="reference/collect.html">collect()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/collect.html">collect</a></span><span class="op">(</span><span class="va">abc</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] "b"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] "c"</span></code></pre></div>
<p>Iterate over an iterator with <code><a href="reference/collect.html">loop()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/collect.html">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="fu">generate_abc</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; [1] "A"</span>
<span class="co">#&gt; [1] "B"</span>
<span class="co">#&gt; [1] "C"</span></code></pre></div>
<p>See <code><a href="articles/generator.html">vignette("generator")</a></code> for more information.</p>
</div>
<div id="compatibility-with-the-reticulate-package" class="section level3">
<h3 class="hasAnchor">
<a href="#compatibility-with-the-reticulate-package" class="anchor"></a>Compatibility with the reticulate package</h3>
<p>Python iterators imported with the <a href="https://rstudio.github.io/reticulate/">reticulate</a> package are compatible with <code><a href="reference/collect.html">loop()</a></code> and <code><a href="reference/collect.html">collect()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/reticulate">reticulate</a></span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/reticulate/man/py_run.html">py_run_string</a></span><span class="op">(</span><span class="st">"
def first_n(n):
    num = 1
    while num &lt;= n:
        yield num
        num += 1
"</span><span class="op">)</span>

<span class="fu"><a href="reference/collect.html">loop</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">py</span><span class="op">$</span><span class="fu">first_n</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; [1] 2</span>
<span class="co">#&gt; [1] 4</span>
<span class="co">#&gt; [1] 6</span></code></pre></div>
<p>They can also be composed with coro generators:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/generator.html">generator</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">it</span>, <span class="va">n</span><span class="op">)</span> <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">it</span><span class="op">)</span> <span class="fu"><a href="reference/yield.html">yield</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span>

<span class="va">composed</span> <span class="op">&lt;-</span> <span class="fu">times</span><span class="op">(</span><span class="va">py</span><span class="op">$</span><span class="fu">first_n</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>

<span class="fu"><a href="reference/collect.html">collect</a></span><span class="op">(</span><span class="va">composed</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 10</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 20</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 30</span></code></pre></div>
</div>
</div>
<div id="limitations" class="section level2">
<h2 class="hasAnchor">
<a href="#limitations" class="anchor"></a>Limitations</h2>
<p><code><a href="reference/yield.html">yield()</a></code> and <code><a href="reference/async.html">await()</a></code> can be used in loops, if/else branches, <code><a href="https://rdrr.io/r/base/conditions.html">tryCatch()</a></code> expressions, or any combinations of these. However they can’t be used as function arguments. These will cause errors:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/generator.html">generator</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="reference/yield.html">yield</a></span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="fu"><a href="reference/async.html">async</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="reference/async.html">await</a></span><span class="op">(</span><span class="fu">foo</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Fortunately it is easy to rewrite the code to work around this limitation:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/generator.html">generator</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/yield.html">yield</a></span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="fu"><a href="reference/async.html">async</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/async.html">await</a></span><span class="op">(</span><span class="fu">foo</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
<div id="how-does-it-work" class="section level2">
<h2 class="hasAnchor">
<a href="#how-does-it-work" class="anchor"></a>How does it work</h2>
<p>Coroutines are an <a href="https://eli.thegreenplace.net/2009/08/29/co-routines-as-an-alternative-to-state-machines">abstraction for state machines</a> in languages that support them. Conversely, you can implement coroutines by rewriting the code source provided by the user as a state machine. Pass <code>internals = TRUE</code> to the print methods of coroutines to reveal the state machine that is running under the hood:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">generate_abc</span>, internals <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; &lt;generator&gt;</span>
<span class="co">#&gt; function() {</span>
<span class="co">#&gt;   for (x in letters[1:3]) {</span>
<span class="co">#&gt;     yield(x)</span>
<span class="co">#&gt;   }</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; State machine:</span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     if (exhausted) {</span>
<span class="co">#&gt;         return(invisible(exhausted()))</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt;     repeat switch(state[[1L]], `1` = {</span>
<span class="co">#&gt;         iterators[[2L]] &lt;- as_iterator(user(letters[1:3]))</span>
<span class="co">#&gt;         state[[1L]] &lt;- 2L</span>
<span class="co">#&gt;         state[[2L]] &lt;- 1L</span>
<span class="co">#&gt;     }, `2` = {</span>
<span class="co">#&gt;         repeat switch(state[[2L]], `1` = {</span>
<span class="co">#&gt;             if ({</span>
<span class="co">#&gt;                 iterator &lt;- iterators[[2L]]</span>
<span class="co">#&gt;                 if (is_exhausted(elt &lt;- iterator())) {</span>
<span class="co">#&gt;                   FALSE</span>
<span class="co">#&gt;                 } else {</span>
<span class="co">#&gt;                   user_env[["x"]] &lt;- elt</span>
<span class="co">#&gt;                   TRUE</span>
<span class="co">#&gt;                 }</span>
<span class="co">#&gt;             }) {</span>
<span class="co">#&gt;                 state[[2L]] &lt;- 2L</span>
<span class="co">#&gt;             } else {</span>
<span class="co">#&gt;                 break</span>
<span class="co">#&gt;             }</span>
<span class="co">#&gt;         }, `2` = {</span>
<span class="co">#&gt;             user({</span>
<span class="co">#&gt;                 x</span>
<span class="co">#&gt;             })</span>
<span class="co">#&gt;             state[[2L]] &lt;- 3L</span>
<span class="co">#&gt;             suspend()</span>
<span class="co">#&gt;             return(last_value())</span>
<span class="co">#&gt;         }, `3` = {</span>
<span class="co">#&gt;             .last_value &lt;- if (missing(arg)) NULL else arg</span>
<span class="co">#&gt;             state[[2L]] &lt;- 1L</span>
<span class="co">#&gt;         })</span>
<span class="co">#&gt;         iterators[[2L]] &lt;- NULL</span>
<span class="co">#&gt;         length(state) &lt;- 1L</span>
<span class="co">#&gt;         break</span>
<span class="co">#&gt;     })</span>
<span class="co">#&gt;     exhausted &lt;- TRUE</span>
<span class="co">#&gt;     invisible(exhausted())</span>
<span class="co">#&gt; }</span></code></pre></div>
<p>Despite this transformation of source code, <code><a href="https://rdrr.io/r/base/browser.html">browser()</a></code> and step-debugging still work as you would expect. This is because coro keeps track of the source references from the original code.</p>
</div>
<div id="acknowledgements" class="section level2">
<h2 class="hasAnchor">
<a href="#acknowledgements" class="anchor"></a>Acknowledgements</h2>
<ul>
<li><p>The <a href="https://facebook.github.io/regenerator/">regenerator</a> Javascript package which uses a similar transformation to implement generators and async functions in older versions of Javascript.</p></li>
<li><p>Gabor Csardi for many interesting discussions about concurrency and the design of coro.</p></li>
</ul>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>Install the development version from github with:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("devtools")</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"r-lib/coro"</span>, build_vignettes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=coro">https://​cloud.r-project.org/​package=coro</a>
</li>
<li>Browse source code at <br><a href="https://github.com/r-lib/coro/">https://​github.com/​r-lib/​coro/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/r-lib/coro/issues">https://​github.com/​r-lib/​coro/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Lionel Henry <br><small class="roles"> Author, maintainer </small>  </li>
<li><a href="authors.html">All authors...</a></li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://cran.r-project.org/package=coro"><img src="https://www.r-pkg.org/badges/version/coro" alt="CRAN status"></a></li>
<li><a href="https://github.com/r-lib/coro/actions"><img src="https://github.com/r-lib/coro/workflows/R-CMD-check/badge.svg" alt="R build status"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Lionel Henry.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
